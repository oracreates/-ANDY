<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sipp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    canvas {
      image-rendering: pixelated;
      image-rendering: crisp-edges;
    }
  </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-pink-200 via-purple-200 to-blue-200 flex items-center justify-center p-4">

<div class="bg-white rounded-3xl shadow-xl max-w-md w-full p-6 text-center">

  <!-- LANDING -->
  <h1 class="text-4xl font-black mb-2">Sipp</h1>
  <p class="text-gray-600 mb-6">Your pixels, your identity</p>

  <!-- CONNECT -->
  <button id="connectBtn"
    class="w-full py-3 bg-black text-white rounded-xl font-semibold mb-4">
    Connect Wallet
  </button>

  <!-- AVATAR -->
  <div id="reveal" class="hidden">
    <canvas id="pfp" width="256" height="256" class="mx-auto rounded-xl border-4 border-black mb-4"></canvas>

    <!-- METADATA -->
    <div class="text-sm text-left bg-gray-100 rounded-xl p-3 mb-4">
      <p><strong>Sipp ID:</strong> <span id="sippId"></span></p>
      <p><strong>Origin:</strong> Wallet-bound</p>
      <p><strong>Status:</strong> Unchanged</p>
    </div>

    <!-- FLOW -->
    <button id="downloadBtn"
      class="w-full py-3 bg-purple-600 text-white rounded-xl font-semibold mb-3">
      Download
    </button>

    <button id="supportBtn"
      class="w-full py-3 bg-green-600 text-white rounded-xl font-semibold">
      Support the Build
    </button>
  </div>

</div>

<script>
let walletAddress = null;
const DESTINATION = "FQQRbHAgKUQjV2uWxx56a6GTGQLEdvQCoCAT52LGCmD";

// CONNECT
document.getElementById("connectBtn").onclick = async () => {
  if (!window.solflare) {
    alert("Please open in Solflare browser");
    return;
  }
  const res = await window.solflare.connect();
  walletAddress = window.solflare.publicKey.toString();
  document.getElementById("connectBtn").style.display = "none";
  document.getElementById("reveal").classList.remove("hidden");
  generateSipp(walletAddress);
};

// DETERMINISTIC HASH
function hash(str) {
  let h = 0;
  for (let i = 0; i < str.length; i++) {
    h = (h << 5) - h + str.charCodeAt(i);
    h |= 0;
  }
  return Math.abs(h);
}

// GENERATE CHARACTER
function generateSipp(address) {
  const seed = hash(address);
  const ctx = document.getElementById("pfp").getContext("2d");
  ctx.clearRect(0,0,256,256);

  const rnd = n => (seed >> n) & 255;

  const skin = `hsl(${rnd(1)%360},60%,70%)`;
  const eye = rnd(2)%2 ? "â– " : "â—";
  const mouth = rnd(3)%2 ? "_" : "á´—";
  const accessory = rnd(4)%3;

  // background
  ctx.fillStyle = `hsl(${rnd(5)%360},70%,85%)`;
  ctx.fillRect(0,0,256,256);

  // head
  ctx.fillStyle = skin;
  ctx.fillRect(64,32,128,128);

  // shoulders
  ctx.fillStyle = `hsl(${rnd(6)%360},40%,50%)`;
  ctx.fillRect(48,160,160,64);

  // eyes
  ctx.fillStyle = "#000";
  ctx.font = "32px monospace";
  ctx.fillText(eye, 96, 112);
  ctx.fillText(eye, 128, 112);

  // mouth
  ctx.fillText(mouth, 112, 144);

  // accessory
  if (accessory === 1) {
    ctx.fillStyle = "gold";
    ctx.fillRect(80,16,96,16); // halo
  }
  if (accessory === 2) {
    ctx.fillStyle = "black";
    ctx.fillRect(88,80,80,24); // shades
  }

  // ID
  document.getElementById("sippId").textContent =
    "#" + seed.toString(16).slice(0,4).toUpperCase();
}

// DOWNLOAD (opens browser)
document.getElementById("downloadBtn").onclick = () => {
  const canvas = document.getElementById("pfp");
  const url = canvas.toDataURL("image/png");
  window.open(url, "_blank");
};

// SUPPORT THE BUILD
document.getElementById("supportBtn").onclick = async () => {
  const amount = prompt("Enter SOL amount to support");
  if (!amount) return;

  try {
    await window.solflare.request({
      method: "transfer",
      params: {
        recipient: DESTINATION,
        amount: parseFloat(amount)
      }
    });
    alert("Thank you for supporting Sipp ðŸ’œ");
  } catch (e) {
    alert("Transaction cancelled");
  }
};
</script>

</body>
</html>