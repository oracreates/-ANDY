<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sipp - Your Pixels, Your Identity</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body {
    margin: 0;
    padding: 0;
}
.pixelated {
    image-rendering: pixelated;
    image-rendering: -moz-crisp-edges;
    image-rendering: crisp-edges;
}
</style>
</head>
<body>
<div id="app" class="min-h-screen bg-gradient-to-br from-yellow-200 via-pink-200 to-purple-300 flex items-center justify-center p-4">
    <div class="max-w-2xl w-full bg-white/20 backdrop-blur-lg rounded-2xl shadow-2xl p-8 border border-white/30">
        <div class="text-center mb-6">
            <h1 class="text-5xl font-bold text-purple-900 mb-1">Sipp</h1>
            <p class="text-purple-800 italic text-lg">Your pixels, your identity</p>
        </div>

        <!-- Not Connected -->
        <div id="notConnected" class="flex flex-col items-center space-y-6">
            <div class="flex flex-col gap-3 w-full max-w-sm">
                <button id="connectSolflareBtn"
                    class="px-8 py-4 bg-gradient-to-r from-purple-500 to-pink-500 text-white font-semibold rounded-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200">
                    Connect Solflare Wallet
                </button>
            </div>
            <div id="walletStatus" class="text-sm text-yellow-800 mt-2"></div>
        </div>

        <!-- Connected -->
        <div id="connected" class="space-y-6" style="display: none;">
            <div class="bg-white/10 rounded-lg p-4 border border-white/20">
                <p class="text-sm text-purple-800 mb-1">Drop your Sipp</p>
                <p id="walletAddress" class="text-purple-900 font-mono text-sm break-all"></p>
            </div>

            <div class="flex flex-col items-center space-y-4">
                <div class="bg-white/10 p-6 rounded-xl border-4 border-white/20 shadow-2xl">
                    <canvas id="pixelCanvas" class="rounded-lg pixelated"></canvas>
                </div>

                <button id="downloadBtn"
                    class="px-6 py-3 bg-green-500 hover:bg-green-600 text-white font-semibold rounded-lg shadow-lg transform hover:scale-105 transition-all duration-200">
                    Download / Open
                </button>

                <button id="regenerateBtn" class="text-sm text-purple-800 hover:text-purple-700 underline">
                    Regenerate ($0.5)
                </button>

                <button id="disconnectBtn"
                    class="px-6 py-3 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-lg shadow-lg transform hover:scale-105 transition-all duration-200">
                    Disconnect
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let walletAddress = null;
let currentProvider = null;

// Wallet detection
window.addEventListener('load', async () => {
    await new Promise(r => setTimeout(r, 500));
    const hasSolflare = window.solflare;
    const statusEl = document.getElementById('walletStatus');
    if(!hasSolflare){
        statusEl.textContent = '⚠️ Solflare wallet not detected. Please install Solflare.';
        statusEl.classList.add('text-red-700');
    } else {
        statusEl.textContent = '✅ Solflare detected!';
        statusEl.classList.add('text-green-700');
    }
});

// Connect wallet
async function connectSolflare(){
    try{
        if(!window.solflare){
            alert('Please install Solflare!');
            window.open('https://solflare.com/', '_blank');
            return;
        }
        await window.solflare.connect();
        if(window.solflare.publicKey){
            walletAddress = window.solflare.publicKey.toString();
            currentProvider = window.solflare;
            document.getElementById('walletAddress').textContent = walletAddress;
            document.getElementById('notConnected').style.display = 'none';
            document.getElementById('connected').style.display = 'block';
            generatePixelArt(walletAddress);
        }
    } catch(e){
        console.error(e);
        alert('Connection failed');
    }
}

// Disconnect
function disconnectWallet(){
    if(currentProvider && currentProvider.disconnect){
        currentProvider.disconnect();
    }
    walletAddress = null;
    currentProvider = null;
    document.getElementById('notConnected').style.display = 'flex';
    document.getElementById('connected').style.display = 'none';
}

// Pixel NFT generator
function generatePixelArt(address){
    const canvas = document.getElementById('pixelCanvas');
    const ctx = canvas.getContext('2d');
    const gridSize = 16;
    const pixelSize = 20;
    canvas.width = gridSize*pixelSize;
    canvas.height = gridSize*pixelSize;
    ctx.clearRect(0,0,canvas.width,canvas.height);

    let hash=0;
    for(let i=0;i<address.length;i++){
        hash = address.charCodeAt(i)+((hash<<5)-hash);
    }
    const hue = Math.abs(hash)%360;
    const colors=[
        `hsl(${hue},70%,60%)`,
        `hsl(${(hue+30)%360},70%,50%)`,
        `hsl(${(hue+60)%360},70%,55%)`,
        `hsl(${(hue+90)%360},70%,45%)`,
        `hsl(${(hue+120)%360},70%,50%)`
    ];

    for(let y=0;y<gridSize;y++){
        for(let x=0;x<gridSize;x++){
            const index = y*gridSize + x;
            const charCode = address.charCodeAt(index%address.length);
            const actualX = x<gridSize/2 ? x : gridSize-1-x;
            const seed=(charCode+actualX+y)%100;
            if(seed>30){
                const colorIndex=(charCode+actualX+y)%colors.length;
                ctx.fillStyle=colors[colorIndex];
                ctx.fillRect(x*pixelSize,y*pixelSize,pixelSize,pixelSize);
                ctx.strokeStyle='rgba(0,0,0,0.1)';
                ctx.strokeRect(x*pixelSize,y*pixelSize,pixelSize,pixelSize);
            }
        }
    }
}

// Convert dataURL to blob
function dataURLtoBlob(dataurl){
    const arr=dataurl.split(',');
    const mime=arr[0].match(/:(.*?);/)[1];
    const bstr=atob(arr[1]);
    let n=bstr.length;
    const u8arr=new Uint8Array(n);
    while(n--){
        u8arr[n]=bstr.charCodeAt(n);
    }
    return new Blob([u8arr], {type:mime});
}

// Download / open
function downloadNFT(){
    const canvas=document.getElementById('pixelCanvas');
    const imageData=canvas.toDataURL();
    const blob=dataURLtoBlob(imageData);
    const url=URL.createObjectURL(blob);

    const isSolflare=/Solflare/i.test(navigator.userAgent);
    if(isSolflare){
        alert('⚠️ Solflare browser blocks downloads. Open this link in Chrome or Safari to save your Sipp.');
    }

    window.open(url,'_blank');
}

// Event listeners
document.getElementById('connectSolflareBtn').addEventListener('click',connectSolflare);
document.getElementById('disconnectBtn').addEventListener('click',disconnectWallet);
document.getElementById('downloadBtn').addEventListener('click',downloadNFT);
document.getElementById('regenerateBtn').addEventListener('click',()=>{if(walletAddress){generatePixelArt(walletAddress)}});

</script>
</body>
</html>