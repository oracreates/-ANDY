<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Wallet Pixel NFT</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    canvas {
      image-rendering: pixelated;
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 flex items-center justify-center p-4">

<div class="max-w-xl w-full bg-white/10 backdrop-blur-xl rounded-2xl p-6 border border-white/20 text-center">
  <h1 class="text-3xl font-bold text-white mb-2">Wallet Pixel NFT</h1>
  <p class="text-purple-300 mb-6">Your wallet, your identity</p>

  <!-- NOT CONNECTED -->
  <div id="notConnected" class="space-y-4">
    <button id="connectSolflare" class="w-full py-3 bg-gradient-to-r from-purple-500 to-blue-500 text-white rounded-lg font-semibold">
      Connect Solflare
    </button>
    <button id="connectPhantom" class="w-full py-3 bg-gradient-to-r from-indigo-500 to-purple-500 text-white rounded-lg font-semibold">
      Connect Phantom
    </button>
    <p id="status" class="text-yellow-300 text-sm"></p>
  </div>

  <!-- CONNECTED -->
  <div id="connected" class="hidden space-y-4">
    <p class="text-purple-300 text-sm break-all" id="walletAddress"></p>

    <div class="flex justify-center">
      <canvas id="pixelCanvas" width="320" height="320" class="rounded-xl border-4 border-white/30"></canvas>
    </div>

    <div class="flex gap-3 justify-center">
      <button id="regen" class="px-4 py-2 bg-purple-500 text-white rounded-lg">Regenerate</button>
      <button id="download" class="px-4 py-2 bg-green-500 text-white rounded-lg">Download</button>
      <button id="disconnect" class="px-4 py-2 bg-red-500 text-white rounded-lg">Disconnect</button>
    </div>
  </div>
</div>

<script>
let walletAddress = null;
let provider = null;

const canvas = document.getElementById("pixelCanvas");
const ctx = canvas.getContext("2d");

function hashString(str) {
  let h = 0;
  for (let i = 0; i < str.length; i++) {
    h = (h << 5) - h + str.charCodeAt(i);
    h |= 0;
  }
  return Math.abs(h);
}

function generatePixelArt(address) {
  const grid = 16;
  const size = 20;

  ctx.clearRect(0, 0, canvas.width, canvas.height);

  const seed = hashString(address);
  const hue = seed % 360;

  const palette = [
    `hsl(${hue},70%,60%)`,
    `hsl(${(hue+30)%360},70%,50%)`,
    `hsl(${(hue+60)%360},70%,55%)`,
    `hsl(${(hue+90)%360},70%,45%)`
  ];

  for (let y = 0; y < grid; y++) {
    for (let x = 0; x < grid / 2; x++) {
      const v = (seed + x * 31 + y * 17) % 100;
      if (v > 45) {
        const color = palette[(x + y) % palette.length];
        ctx.fillStyle = color;

        ctx.fillRect(x * size, y * size, size, size);
        ctx.fillRect((grid - 1 - x) * size, y * size, size, size);
      }
    }
  }
}

function showConnected() {
  document.getElementById("notConnected").classList.add("hidden");
  document.getElementById("connected").classList.remove("hidden");
  document.getElementById("walletAddress").textContent = walletAddress;
  generatePixelArt(walletAddress);
}

async function connectSolflare() {
  if (!window.solflare) {
    alert("Install Solflare");
    return;
  }
  await window.solflare.connect();
  provider = window.solflare;
  walletAddress = provider.publicKey.toString();
  showConnected();
}

async function connectPhantom() {
  if (!window.solana || !window.solana.isPhantom) {
    alert("Install Phantom");
    return;
  }
  const res = await window.solana.connect();
  provider = window.solana;
  walletAddress = res.publicKey.toString();
  showConnected();
}

function disconnect() {
  if (provider?.disconnect) provider.disconnect();
  walletAddress = null;
  provider = null;
  document.getElementById("connected").classList.add("hidden");
  document.getElementById("notConnected").classList.remove("hidden");
}

document.getElementById("connectSolflare").onclick = connectSolflare;
document.getElementById("connectPhantom").onclick = connectPhantom;
document.getElementById("disconnect").onclick = disconnect;
document.getElementById("regen").onclick = () => generatePixelArt(walletAddress);
document.getElementById("download").onclick = () => {
  const a = document.createElement("a");
  a.download = "wallet-pixel-nft.png";
  a.href = canvas.toDataURL();
  a.click();
};
</script>

</body>
</html>